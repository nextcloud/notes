!function(a,b,c,d,e,f){"use strict";Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e});var g=a.module("Notes",["restangular","ngRoute"]).config(["$provide","$routeProvider","RestangularProvider","$httpProvider","$windowProvider",function(a,b,d,e,f){e.defaults.headers.common.requesttoken=c,a.value("Constants",{saveInterval:5e3}),b.when("/notes/:noteId",{templateUrl:"note.html",controller:"NoteController",resolve:{note:["$route","$q","is","Restangular",function(a,b,c,d){var e=b.defer(),f=a.current.params.noteId;return c.loading=!0,d.one("notes",f).get().then(function(a){c.loading=!1,e.resolve(a)},function(){c.loading=!1,e.reject()}),e.promise}]}}).otherwise({redirectTo:"/"});var g=f.$get(),h=g.location.href,i=h.split("index.php")[0]+"index.php/apps/notes";d.setBaseUrl(i)}]).run(["$rootScope","$location","NotesModel","Config",function(a,b,c,d){d.load(),a.$on("$routeChangeError",function(){var a=c.getAll();if(a.length>0){var d=(a.sort(function(a,b){return a.modified>b.modified?1:a.modified<b.modified?-1:0}),a[a.length-1]);b.path("/notes/"+d.id)}else b.path("/")})}]);g.controller("AppController",["$scope","$location","is",function(a,b,c){a.is=c,a.init=function(a){0!==a&&b.path("/notes/"+a)}}]),g.controller("NoteController",["$routeParams","$scope","NotesModel","SaveQueue","note","Config",function(a,b,c,d,e,f){c.updateIfExists(e),b.note=c.get(a.noteId),b.config=f,b.markdown=f.isMarkdown(),b.isSaving=function(){return d.isSaving()},b.updateTitle=function(){b.note.title=b.note.content.split("\n")[0]||b.translations["New note"]},b.save=function(){var a=b.note;d.add(a)},b.sync=function(a){f.setIsMarkdown(a),f.sync()}}]),g.controller("NotesController",["$routeParams","$scope","$location","Restangular","NotesModel",function(a,b,c,d,e){b.route=a,b.notes=e.getAll();var f=d.all("notes");f.getList().then(function(a){e.addAll(a)}),b.create=function(){f.post().then(function(a){e.add(a),c.path("/notes/"+a.id)})},b["delete"]=function(a){var c=e.get(a);c.remove().then(function(){e.remove(a),b.$emit("$routeChangeError")})}}]),g.directive("notesAutofocus",function(){return{restrict:"A",link:function(a,b,c){b.focus()}}}),g.directive("notesIsSaving",["$window",function(a){return{restrict:"A",scope:{notesIsSaving:"="},link:function(b,c,d){a.onbeforeunload=function(){return b.notesIsSaving?t("notes","Note is currently saving. Leaving the page will delete all changes!"):null}}}}]),g.directive("markdown",function(){return d.setOptions({sanitize:!0,gfm:!0,tables:!0,breaks:!0,smartLists:!0,highlight:function(a){return e.highlightAuto(a).value}}),{restrict:"AE",link:function(a,b,c){if(c.markdown)a.$watch(c.markdown,function(a){var c=d(a);b.html(c)});else{var e=d(b.text());b.html(e)}}}}),g.directive("notesTimeoutChange",["$timeout",function(a){return{restrict:"A",link:function(c,d,e){var f,g=300;b(d).bind("input propertychange",function(){a.cancel(f),f=a(function(){c.$apply(e.notesTimeoutChange)},g)})}}}]),g.directive("notesTooltip",function(){return{restrict:"A",link:function(a,b,c){b.tooltip()}}}),g.directive("notesTranslate",function(){return{restrict:"E",link:function(a,c,d){var e=b(c);e.hide(),a.translations=a.translations||{},a.translations[d.key]=e.text()}}}),g.factory("Config",["Restangular",function(a){var b=function(a){this._markdown=!1,this._Restangular=a};return b.prototype.load=function(){var a=this;this._Restangular.one("config").get().then(function(b){a._markdown=b.markdown})},b.prototype.isMarkdown=function(){return this._markdown},b.prototype.setIsMarkdown=function(a){this._markdown=a},b.prototype.sync=function(){return this._Restangular.one("config").customPOST({markdown:this._markdown})},new b(a)}]),g.factory("is",function(){return{loading:!1}}),g.factory("NotesModel",function(){var b=function(){this.notes=[],this.notesIds={}};return b.prototype={addAll:function(a){for(var b=0;b<a.length;b++)this.add(a[b])},add:function(a){this.updateIfExists(a)},getAll:function(){return this.notes},get:function(a){return this.notesIds[a]},updateIfExists:function(b){var c=this.notesIds[b.id];a.isDefined(c)?(c.title=b.title,c.modified=b.modified,c.content=b.content):(this.notes.push(b),this.notesIds[b.id]=b)},remove:function(a){for(var b=0;b<this.notes.length;b++){var c=this.notes[b];if(c.id===a){this.notes.splice(b,1),delete this.notesIds[a];break}}}},new b}),g.factory("SaveQueue",["$q",function(a){var b=function(){this._queue={},this._flushLock=!1};return b.prototype={add:function(a){this._queue[a.id]=a,this._flush()},_flush:function(){var b=Object.keys(this._queue);if(0!==b.length&&!this._flushLock){this._flushLock=!0;for(var c=this,d=[],e=0;e<b.length;e++){var f=this._queue[b[e]];d.push(f.put().then(this._noteUpdateRequest.bind(null,f)))}this._queue={},a.all(d).then(function(){c._flushLock=!1,c._flush()})}},_noteUpdateRequest:function(a,b){a.title=b.title,a.modified=b.modified},isSaving:function(){return this._flushLock}},new b}])}(angular,jQuery,oc_requesttoken,marked,hljs);
//# sourceMappingURL=app.min.js.map